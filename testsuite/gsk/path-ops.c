/*
 * Copyright Â© 2022 Red Hat, Inc.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library. If not, see <http://www.gnu.org/licenses/>.
 *
 * Authors: Matthias Clasen <mclasen@redhat.com>
 */

#include <gtk/gtk.h>
#include "gsk/gskpathprivate.h"

static void
test_ops_simple (void)
{
  struct {
    const char *in1;
    const char *in2;
    GskPathOp op;
    const char *out;
  } tests[] = {
    /* partially overlapping edge */
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 150 150 L 150 250 L 250 250 Z",
      GSK_PATH_OP_UNION,
      "M 100 100 L 100 200 L 150 200 L 150 250 L 250 250 L 200 200 L 150 150 L 100 100 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 150 150 L 150 250 L 250 250 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 150 200 L 200 200 L 150 150 L 150 200 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 150 150 L 150 250 L 250 250 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 100 100 L 100 200 L 150 200 L 150 150 L 100 100 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 150 150 L 150 250 L 250 250 Z",
      GSK_PATH_OP_XOR,
      "M 100 100 L 100 200 L 150 200 L 150 150 L 100 100 Z M 200 200 L 150 200 L 150 250 "
      "L 250 250 L 200 200 Z" },
    /* two triangles in general position */
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 170 120 L 100 240 L 170 240 Z",
      GSK_PATH_OP_UNION,
      "M 100 100 L 100 200 L 123.33333587646484 200 L 100 240 L 170 240 L 170 200 L 200 200 "
      "L 170 170 L 170 120 L 151.57894897460938 151.57894897460938 L 100 100 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 170 120 L 100 240 L 170 240 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 123.33333587646484 200 L 170 200 L 170 170 L 151.57894897460938 151.57894897460938 "
      "L 123.33332824707031 200 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 170 120 L 100 240 L 170 240 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 100 100 L 100 200 L 123.33333587646484 200 L 151.57894897460938 151.57894897460938 "
      "L 100 100 Z M 170 200 L 200 200 L 170 170 L 170 200 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 170 120 L 100 240 L 170 240 Z",
      GSK_PATH_OP_XOR,
      "M 100 100 L 100 200 L 123.33333587646484 200 L 151.57894897460938 151.57894897460938 "
      "L 100 100 Z M 170 200 L 123.33333587646484 200 L 100 240 L 170 240 L 170 200 Z "
      "M 170 200 L 200 200 L 170 170 L 170 200 Z M 151.57894897460938 151.57894897460938 "
      "L 170 170 L 170 120 L 151.57894897460938 151.57894897460938 Z" },
    /* nested contours, oriented in opposite direction */
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 170 190 L 120 190 Z",
      GSK_PATH_OP_UNION,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 170 190 L 120 190 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 170 190 L 120 140 L 120 190 L 170 190 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 170 190 L 120 190 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z M 120 140 L 170 190 L 120 190 L 120 140 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 170 190 L 120 190 Z",
      GSK_PATH_OP_XOR,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z M 120 140 L 170 190 L 120 190 L 120 140 Z" },
    /* nested contours, oriented in opposite direction, other way around */
    { "M 100 100 L 200 200 L 100 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_UNION,
      "M 200 200 L 100 100 L 100 200 L 200 200 Z" },
    { "M 100 100 L 200 200 L 100 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 120 140 L 120 190 L 170 190 L 120 140 Z" },
    { "M 100 100 L 200 200 L 100 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 200 200 L 100 100 L 100 200 L 200 200 Z M 120 190 L 120 140 L 170 190 L 120 190 Z" },
    { "M 100 100 L 200 200 L 100 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_XOR,
      "M 200 200 L 100 100 L 100 200 L 200 200 Z M 120 190 L 120 140 L 170 190 L 120 190 Z" },
    /* nested contours, oriented in the same direction */
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_UNION,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 120 140 L 120 190 L 170 190 L 120 140 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z M 120 190 L 120 140 L 170 190 L 120 190 Z" },
    { "M 100 100 L 100 200 L 200 200 Z",
      "M 120 140 L 120 190 L 170 190 Z",
      GSK_PATH_OP_XOR,
      "M 100 100 L 100 200 L 200 200 L 100 100 Z M 120 190 L 120 140 L 170 190 L 120 190 Z" },
    /* a 3-way intersection */
    { "M 100 200 L 150 104 L 145 104 L 200 200 Z",
      "M 100 108.571 L 200 108.571 L 200 50 L 100 50 Z",
      GSK_PATH_OP_UNION,
      "M 147.61904907226562 108.57142639160156 L 100 200 L 200 200 "
      "L 147.61904907226562 108.57142639160156 Z M 100 108.57099914550781 "
      "L 147.61927795410156 108.57099914550781 L 200 108.57099914550781 L 200 50 "
      "L 100 50 L 100 108.57099914550781 Z" },
    { "M 100 200 L 150 104 L 145 104 L 200 200 Z",
      "M 100 108.571 L 200 108.571 L 200 50 L 100 50 Z",
      GSK_PATH_OP_INTERSECTION,
      "M 147.61904907226562 108.57142639160156 L 150 104 L 145 104 "
      "L 147.61904907226562 108.57142639160156 Z" },
    { "M 100 200 L 150 104 L 145 104 L 200 200 Z",
      "M 100 108.571 L 200 108.571 L 200 50 L 100 50 Z",
      GSK_PATH_OP_DIFFERENCE,
      "M 147.61904907226562 108.57142639160156 L 100 200 L 200 200 "
      "L 147.61904907226562 108.57142639160156 Z" },
    { "M 100 200 L 150 104 L 145 104 L 200 200 Z",
      "M 100 108.571 L 200 108.571 L 200 50 L 100 50 Z",
      GSK_PATH_OP_XOR,
      "M 147.61904907226562 108.57142639160156 L 100 200 L 200 200 "
      "L 147.61904907226562 108.57142639160156 Z M 150 104 "
      "L 147.61904907226562 108.57142639160156 L 200 108.57099914550781 "
      "L 200 50 L 100 50 L 100 108.57099914550781 L 147.61927795410156 108.57099914550781 "
      "L 145 104 L 150 104 Z" },
     /* touching quadratics */
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 200 Q 150 100 200 200 Z",
       GSK_PATH_OP_UNION,
       "M 100 100 Q 124.98798370361328 149.97596740722656, 149.97596740722656 149.99998474121094 Q 174.98797607421875 149.97596740722656, 200 200 L 100 200 Q 124.98798370361328 150.02403259277344, 149.97596740722656 150.00001525878906 Q 174.98797607421875 150.02403259277344, 200 100 L 100 100 Z"
     },
     /* overlapping quadratics, two intersections, different orientations */
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 Q 150 80 200 180 Z",
       GSK_PATH_OP_UNION,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 113.81969451904297 152.36061096191406, 100 180 L 200 180 Q 186.18031311035156 152.36061096191406, 172.36061096191406 139.99993896484375 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 Q 150 80 200 180 Z",
       GSK_PATH_OP_INTERSECTION,
       "M 127.63862609863281 139.9993896484375 Q 149.99961853027344 160.00027465820312, 172.36061096191406 140.00006103515625 Q 150 120.00006103515625, 127.63938903808594 139.99993896484375 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 Q 150 80 200 180 Z",
       GSK_PATH_OP_DIFFERENCE,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 150 120.00006103515625, 172.36061096191406 139.99993896484375 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 Q 150 80 200 180 Z",
       GSK_PATH_OP_XOR,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 150 120.00006103515625, 172.36061096191406 139.99993896484375 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z M 172.36061096191406 140.00006103515625 Q 149.99961853027344 160.00027465820312, 127.63862609863281 139.99937438964844 Q 113.81969451904297 152.36061096191406, 100 180 L 200 180 Q 186.18031311035156 152.36061096191406, 172.36061096191406 139.99993896484375 Z"
     },
     /* overlapping quadratics, two intersections, same orientation */
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 L 200 180 Q 150 80 100 180 Z",
       GSK_PATH_OP_UNION,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 113.81969451904297 152.36061096191406, 100 180 L 200 180 Q 186.18069458007812 152.36137390136719, 172.36138916015625 140.00062561035156 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 L 200 180 Q 150 80 100 180 Z",
       GSK_PATH_OP_INTERSECTION,
       "M 127.63862609863281 139.9993896484375 Q 149.99961853027344 160.00027465820312, 172.36061096191406 140.00006103515625 Q 150.00039672851562 119.99972534179688, 127.63939666748047 139.99993896484375 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 L 200 180 Q 150 80 100 180 Z",
       GSK_PATH_OP_DIFFERENCE,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 150.00039672851562 119.99972534179688, 172.36138916015625 140.00062561035156 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z"
     },
     { "M 100 100 Q 150 200 200 100 Z",
       "M 100 180 L 200 180 Q 150 80 100 180 Z",
       GSK_PATH_OP_XOR,
       "M 100 100 Q 113.81931304931641 127.63862609863281, 127.63862609863281 139.99937438964844 Q 150.00039672851562 119.99972534179688, 172.36138916015625 140.00062561035156 Q 186.1802978515625 127.63938903808594, 200 100 L 100 100 Z M 172.36061096191406 140.00006103515625 Q 149.99961853027344 160.00027465820312, 127.63862609863281 139.99937438964844 Q 113.81969451904297 152.36061096191406, 100 180 L 200 180 Q 186.18069458007812 152.36137390136719, 172.36138916015625 140.00062561035156 Z"
     },
     /* two polygons with near edges */
     { "M 100 100 L 100 200 L 400 200 L 400 100 Z",
       "M 150 103 L 250 100 L 300 103 L 250 180 Z",
       GSK_PATH_OP_UNION,
       "M 100 100 L 100 200 L 400 200 L 400 100 L 250 100 L 100 100 Z" },
     { "M 100 100 L 100 200 L 400 200 L 400 100 Z",
       "M 150 103 L 250 100 L 300 103 L 250 180 Z",
       GSK_PATH_OP_INTERSECTION,
      "M 250 100 L 150 103 L 250 180 L 300 103 L 250 100 Z" },
     { "M 100 100 L 100 200 L 400 200 L 400 100 Z",
       "M 150 103 L 250 100 L 300 103 L 250 180 Z",
       GSK_PATH_OP_DIFFERENCE,
       "M 100 100 L 100 200 L 400 200 L 400 100 L 250 100 L 300 103 L 250 180 L 150 103 L 250 100 L 100 100 Z" },
     { "M 100 100 L 100 200 L 400 200 L 400 100 Z",
       "M 150 103 L 250 100 L 300 103 L 250 180 Z",
       GSK_PATH_OP_XOR,
       "M 100 100 L 100 200 L 400 200 L 400 100 L 250 100 L 300 103 L 250 180 L 150 103 L 250 100 L 100 100 Z" },
     /* Collinear line segments */
     { "M 100 100 L 200 100 L 250 100 L 100 200 Z",
       "M 150 100 L 300 100 L 300 200 Z",
       GSK_PATH_OP_UNION,
       "M 150 100 L 100 100 L 100 200 L 200 133.33332824707031 L 300 200 L 300 100 L 250 100 "
       "L 200 100 L 150 100 Z" },
     { "M 100 100 L 200 100 L 250 100 L 100 200 Z",
       "M 150 100 L 300 100 L 300 200 Z",
       GSK_PATH_OP_INTERSECTION,
       "M 200 100 L 150 100 L 200 133.33332824707031 L 250 100 L 200 100 Z" },
     { "M 100 100 L 200 100 L 250 100 L 100 200 Z",
       "M 150 100 L 300 100 L 300 200 Z",
       GSK_PATH_OP_DIFFERENCE,
       "M 150 100 L 100 100 L 100 200 L 200 133.33332824707031 L 150 100 Z" },
     { "M 100 100 L 200 100 L 250 100 L 100 200 Z",
       "M 150 100 L 300 100 L 300 200 Z",
       GSK_PATH_OP_XOR,
       "M 150 100 L 100 100 L 100 200 L 200 133.33332824707031 L 150 100 Z "
       "M 250 100 L 200 133.33332824707031 L 300 200 L 300 100 L 250 100 Z" },
     /* a complicated intersection */
     { "M 175 100 L 175 400 L 300 400 L 300 100 z",
       "M 100 100 C 200 200 200 300 100 400 L 0 400 C 233.35 300 233.35 200 0 100 Z",
       GSK_PATH_OP_UNION,
       "M 175 100 L 175 248.73167419433594 L 175 249.94822692871094 L 175 251.26628112792969 "
       "L 175 400 L 300 400 L 300 100 L 175 100 Z "
       "M 174.9906005859375 248.32115173339844 "
       "C 174.437255859375 198.88076782226562, 149.44038391113281 149.44038391113281, 100 100 "
       "L 0 100 "
       "C 115.68845367431641 149.57722473144531, 174.02178955078125 199.15444946289062, 175 248.73167419433594 "
       "Z "
       "M 100 400 "
       "C 149.44171142578125 350.55828857421875, 174.4385986328125 301.11660766601562, 174.99066162109375 251.67486572265625 "
       "C 174.02340698242188 300.84420776367188, 115.69005584716797 350.42208862304688, 0 400 "
       "L 100 400 "
       "Z" },
 };

  for (int i = 0; i < G_N_ELEMENTS (tests); i++)
    {
      GskPath *p1, *p2, *p;
      char *s;

      if (g_test_verbose ())
        {
          g_test_message ("testcase %d op %d", i, tests[i].op);
          g_test_message ("p1 %s", tests[i].in1);
          g_test_message ("p2 %s", tests[i].in2);
        }

      p1 = gsk_path_parse (tests[i].in1);
      p2 = gsk_path_parse (tests[i].in2);

      p = gsk_path_op (tests[i].op, GSK_FILL_RULE_WINDING, p1, p2);

      g_assert_nonnull (p);
      s = gsk_path_to_string (p);
      g_test_message ("result %s\n", s);
      g_assert_cmpstr (s, ==, tests[i].out);

      g_free (s);
      gsk_path_unref (p);
      gsk_path_unref (p1);
      gsk_path_unref (p2);
    }
}

int
main (int   argc,
      char *argv[])
{
  gtk_test_init (&argc, &argv, NULL);

  g_test_add_func ("/ops/simple", test_ops_simple);

  return g_test_run ();
}
